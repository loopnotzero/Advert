@model Egghead.ViewModels.LoginViewModel

@* @{ ViewData["Title"] = "Login on Egghead"; } *@

<div class="card-box">
    <div class="row">
        <div class="title col-md-12 font-bold text-left m-b-30" style="color: #222">
            <h6>
                Sign in with your Egghead account
            </h6>
        </div>
    </div>
    <form id="form" asp-controller="Account" asp-action="LogIn" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" novalidate="">
        <div class="form-group form-mbt-2 row">
            <div class="col-md-12">
                <label class="floating-label label-required">Email</label>
                <input name="email" type="email"/>
            </div>
        </div>
        <div class="form-group form-mbt-3 row">
            <div class="col-md-12">
                @* todo: Add eye open/closed *@
                <label class="floating-label label-required">Password</label>
                <input name="password" type="password"/>
            </div>
        </div>
        <div class="form-group form-mbt-2 row">
            <div class="input-group">
                <span class="p-t-7">
                    <a href="/Account/SignUp">Forgot your password?</a>
                </span>
                <span class="input-group-btn ml-auto">
                    <button id="eggh-login" class="btn btn-danger w-xs waves-effect waves-light">Next</button>
                </span>
            </div>
        </div>
        <div class="form-group row">
            <div class="container align-center">
                Don't have an account? <a href="/Account/SignUp">Sign Up</a>
            </div>
        </div>
    </form>
</div>

<script>
    function init() {
        var emailInput = $("input[type='email']");
        var passwordInput = $("input[type='password']");
        var floatingLabel = "floating-lable";
        var floatingLabelError = "floating-label-error";
        var labelTransform = "label-transform";
        var labelErrorTransform = "label-error-transform";
        var requestVerificationToken = $("input[name=__RequestVerificationToken]");

        function focusIn(form) {
            var prevElement = form.prev();
            prevElement.addClass(!prevElement.hasClass(floatingLabelError) ? labelTransform : labelErrorTransform);
        }

        function focusOut(form) {
            var prev = form.prev();
            if (!prev.hasClass(floatingLabelError)) {
                prev.toggleClass(labelTransform, !((form[0].value === "") && prev.hasClass(labelTransform)));
            } else {
                prev.toggleClass(labelErrorTransform,
                    !((form[0].value === "") && prev.hasClass(labelErrorTransform)));
                if (!(form[0].value === "")) {
                    prev.removeClass(floatingLabelError + " " + labelErrorTransform)
                        .addClass(floatingLabel + " " + labelTransform);
                    form.css("background", "linear-gradient(to bottom, rgba(255, 255, 255, 0) 96%, #5682a3 96%)");
                }
            }
        }

        function onAjaxRequestError(jqXhr, textStatus, errorThrown) {
            console.log("jqXhr: " + JSON.stringify(jqXhr));
            console.log("Text status: " + JSON.stringify(textStatus));
            console.log("Error thrown: " + JSON.stringify(errorThrown));
            //todo: Add form for reporting bug
        }

        function onAjaxRequestSuccess(response) {   
            console.log("Error message: " + response.errorMessage);
            console.log("Error status code: " + response.errorStatusCode);

            switch (response.errorStatusCode) {
            case 302:
                {
                    window.location.href = response.redirectUrl;
                }
                break;
            case 401:
            case 409:
            case 422:
            case 500:
                {                   
                    //todo: Add css style to float label style
                    if (emailInput.attr("name") === response.tagName) {
                        emailInput
                            .css("background",
                                "linear-gradient(to bottom, rgba(255, 255, 255, 0) 96%, #ee6e73 96%)").prev()
                            .addClass(floatingLabelError + " " + labelErrorTransform).text(response.errorMessage);
                    } else if (passwordInput.attr("name") === response.tagName) {
                        passwordInput
                            .css("background",
                                "linear-gradient(to bottom, rgba(255, 255, 255, 0) 96%, #ee6e73 96%)").prev()
                            .addClass(floatingLabelError + " " + labelErrorTransform).text(response.errorMessage);
                    }
                }
                break;
            }
        }

        $("input[type='email'], input[type='password']").focusin(function() {
            focusIn($(this));
        }).focusout(function() {
            focusOut($(this));
        });

        $("#eggh-login").click(function(e) {
            e.preventDefault();
            var url = $("#form").attr("action");
            console.log("Request url: " + url);
            var token = requestVerificationToken.val();
            console.log("Request verification token: " + token);
            var email = emailInput.val();
            console.log("Email: " + email);
            var password = passwordInput.val();
            console.log("Password: " + password);

            var additionalHeaders = {};

            if (token) {
                additionalHeaders["RequestVerificationToken"] = token;
            }

            $.ajax({
                url: url,
                type: "POST",
                data: JSON.stringify({ email: email, password: password }),
                headers: additionalHeaders,
                contentType: "application/json",
                error: function(jqXhr, textStatus, errorThrown) {
                    onAjaxRequestError(jqXhr, textStatus, errorThrown);
                },
                success: function(response) {
                    onAjaxRequestSuccess(response);
                }
            });

            return false;
        });
    }

    $(document).ready(function() {
        init();
    });
</script>