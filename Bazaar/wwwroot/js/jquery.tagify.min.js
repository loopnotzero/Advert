"use strict";!function(n){function t(n,t){if(!n)return console.warn("Tagify: ","invalid input element ",n),this;this.applySettings(n,t);this.state={};this.value=[];this.listeners={};this.DOM={};this.extend(this,new this.EventDispatcher(this));this.build(n);this.loadOriginalValues();this.events.customBinding.call(this);this.events.binding.call(this);n.autofocus&&this.DOM.input.focus()}n.fn.tagify=function(){var i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return this.each(function(){var u,r=n(this);if(r.data("tagify"))return this;i.isJQueryPlugin=!0;u=new t(r[0],i);r.data("tagify",u)})};t.prototype={isIE:window.document.documentMode,TEXTS:{empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"},DEFAULTS:{delimiters:",",pattern:null,maxTags:1/0,callbacks:{},addTagOnBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,keepInvalidTags:!1,autoComplete:!0,mixTagsAllowedAfter:/,|\.|\:|\s/,dropdown:{classname:"",enabled:2,maxItems:10,itemTemplate:""}},customEventsList:["click","add","remove","invalid","input"],applySettings:function(n,t){var i=n.getAttribute("data-whitelist"),r=n.getAttribute("data-blacklist");if(this.settings=this.extend({},this.DEFAULTS,t),this.settings.readonly=n.hasAttribute("readonly"),this.isIE&&(this.settings.autoComplete=!1),r&&(r=r.split(this.settings.delimiters))instanceof Array&&(this.settings.blacklist=r),i&&(i=i.split(this.settings.delimiters))instanceof Array&&(this.settings.whitelist=i),n.pattern)try{this.settings.pattern=new RegExp(n.pattern)}catch(n){}if(this.settings&&this.settings.delimiters)try{this.settings.delimiters=new RegExp("["+this.settings.delimiters+"]","g")}catch(n){}},parseHTML:function(n){return(new DOMParser).parseFromString(n.trim(),"text/html").body.firstElementChild},escapeHtml:function(n){var i=document.createTextNode(n),t=document.createElement("p");return t.appendChild(i),t.innerHTML},build:function(n){var t=this.DOM,i='<tags class="tagify '+(this.settings.mode?"tagify--mix":"")+" "+n.className+'" '+(this.settings.readonly?"readonly":"")+'>\n                            <div contenteditable data-placeholder="'+(n.placeholder||"&#8203;")+'" class="tagify__input"><\/div>\n                        <\/tags>';t.originalInput=n;t.scope=this.parseHTML(i);t.input=t.scope.querySelector("[contenteditable]");n.parentNode.insertBefore(t.scope,n);0<=this.settings.dropdown.enabled&&this.dropdown.init.call(this)},destroy:function(){this.DOM.scope.parentNode.removeChild(this.DOM.scope)},loadOriginalValues:function(){var n=this.DOM.originalInput.value;if(n){try{n=JSON.parse(n)}catch(n){}"mix"==this.settings.mode?this.parseMixTags(n):this.addTags(n).forEach(function(n){n&&n.classList.add("tagify--noAnim")})}},extend:function(n,t,i){function u(n){var t=Object.prototype.toString.call(n).split(" ")[1].slice(0,-1);return n===Object(n)&&"Array"!=t&&"Function"!=t&&"RegExp"!=t&&"HTMLUnknownElement"!=t}function r(n,t){for(var i in t)t.hasOwnProperty(i)&&(u(t[i])?u(n[i])?r(n[i],t[i]):n[i]=Object.assign({},t[i]):n[i]=t[i])}return n instanceof Object||(n={}),r(n,t),i&&r(n,i),n},EventDispatcher:function(t){var i=document.createTextNode("");this.off=function(n,t){return t&&i.removeEventListener.call(i,n,t),this};this.on=function(n,t){return t&&i.addEventListener.call(i,n,t),this};this.trigger=function(r,u){var f;if(r)if(t.settings.isJQueryPlugin)n(t.DOM.originalInput).triggerHandler(r,[u]);else{try{f=new CustomEvent(r,{detail:u})}catch(r){console.warn(r)}i.dispatchEvent(f)}}},events:{customBinding:function(){var n=this;this.customEventsList.forEach(function(t){n.on(t,n.settings.callbacks[t])})},binding:function(){var i,u=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=this.events.callbacks,f=u?"addEventListener":"removeEventListener";for(var r in u&&!this.listeners.main&&(this.DOM.input.addEventListener(this.isIE?"keydown":"input",t[this.isIE?"onInputIE":"onInput"].bind(this)),this.settings.isJQueryPlugin&&n(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),i=this.listeners.main=this.listeners.main||{paste:["input",t.onPaste.bind(this)],focus:["input",t.onFocusBlur.bind(this)],blur:["input",t.onFocusBlur.bind(this)],keydown:["input",t.onKeydown.bind(this)],click:["scope",t.onClickScope.bind(this)],dblclick:["scope",t.onDoubleClickScope.bind(this)]})this.DOM[i[r][0]][f](r,i[r][1])},callbacks:{onFocusBlur:function(n){var t=n.target.textContent.trim();"mix"!=this.settings.mode&&("focus"==n.type?(this.DOM.scope.classList.add("tagify--focus"),0===this.settings.dropdown.enabled&&this.dropdown.show.call(this)):"blur"==n.type?(this.DOM.scope.classList.remove("tagify--focus"),t&&this.settings.addTagOnBlur&&this.addTags(t,!0).length):(this.DOM.input.removeAttribute("style"),this.dropdown.hide.call(this)))},onKeydown:function(n){var t,u,f=this,i=n.target.textContent,r;if("mix"==this.settings.mode){switch(n.key){case"Backspace":r=[];u=this.DOM.input.children;setTimeout(function(){[].forEach.call(u,function(n){return r.push(n.title)});f.value=f.value.filter(function(n){return-1!=r.indexOf(n.title)})},20)}return!0}switch(n.key){case"Backspace":""!=i&&8203!=i.charCodeAt(0)||(t=(t=this.DOM.scope.querySelectorAll("tag:not(.tagify--hide):not([readonly])"))[t.length-1],this.removeTag(t));break;case"Esc":case"Escape":this.input.set.call(this);n.target.blur();break;case"ArrowRight":case"Tab":if(!i)return!0;case"Enter":n.preventDefault();this.addTags(this.input.value,!0)}},onInput:function(n){var t=this.input.normalize.call(this),i=t.length>=this.settings.dropdown.enabled;if("mix"==this.settings.mode)return this.events.callbacks.onMixTagsInput.call(this,n);t?this.input.value!=t&&(this.input.set.call(this,t,!1),this.trigger("input",t),-1!=t.search(this.settings.delimiters)?this.addTags(t).length&&this.input.set.call(this):0<=this.settings.dropdown.enabled&&this.dropdown[i?"show":"hide"].call(this,t)):this.input.set.call(this,"")},onMixTagsInput:function(){var i,t,r,n,u;window.getSelection&&0<(i=window.getSelection()).rangeCount&&((t=i.getRangeAt(0).cloneRange()).collapse(!0),t.setStart(window.getSelection().focusNode,0),(n=(r=t.toString().split(this.settings.mixTagsAllowedAfter))[r.length-1].match(this.settings.pattern))&&(this.state.tag={prefix:n[0],value:n.input.split(n[0])[1]},n=this.state.tag,u=this.state.tag.value.length>=this.settings.dropdown.enabled));this.update();this.trigger("input",this.extend({},this.state.tag,{textContent:this.DOM.input.textContent}));this.state.tag&&this.dropdown[u?"show":"hide"].call(this,this.state.tag.value)},onInputIE:function(n){var t=this;setTimeout(function(){t.events.callbacks.onInput.call(t,n)})},onPaste:function(){},onClickScope:function(n){var t,i=n.target.closest("tag");"TAGS"==n.target.tagName?this.DOM.input.focus():"X"==n.target.tagName?this.removeTag(n.target.parentNode):i&&(t=this.getNodeIndex(i),this.trigger("click",{tag:i,index:t,data:this.value[t]}))},onEditTagInput:function(n){var i=n.closest("tag"),t=this.input.normalize(n),r=t==n.originalValue||this.validateTag(t);i.classList.toggle("tagify--invalid",!0!==r);i.isValid=r;this.trigger("input",t)},onEditTagBlur:function(n){var r,t=n.closest("tag"),f=this.getNodeIndex(t),i=this.input.normalize(n)||n.originalValue,u=t.isValid;void 0!==u&&!0!==u||(n.textContent=i,this.value[f].value=i,this.update(),(r=n.cloneNode(!0)).removeAttribute("contenteditable"),t.title=i,t.classList.remove("tagify--editable"),n.parentNode.replaceChild(r,n))},onEditTagkeydown:function(n){switch(n.key){case"Esc":case"Escape":n.target.textContent=n.target.originalValue;case"Enter":n.preventDefault();n.target.blur()}},onDoubleClickScope:function(n){var t=n.target.closest("tag"),i=this.settings;"mix"==i.mode||i.readonly||i.enforceWhitelist||!t||t.classList.contains("tagify--editable")||t.hasAttribute("readonly")||this.editTag(t)}}},editTag:function(n){var r=this,t=n.querySelector(".tagify__tag-text"),i=this.events.callbacks;t?(n.classList.add("tagify--editable"),t.originalValue=t.textContent,t.setAttribute("contenteditable",!0),t.addEventListener("blur",i.onEditTagBlur.bind(this,t)),t.addEventListener("input",i.onEditTagInput.bind(this,t)),t.addEventListener("keydown",function(n){return i.onEditTagkeydown.call(r,n)}),t.focus()):console.warn("Cannot find element in Tag template: ",".tagify__tag-text")},input:{value:"",set:function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];this.input.value=n;t&&(this.DOM.input.innerHTML=n);n||this.dropdown.hide.call(this);n.length<2&&this.input.autocomplete.suggest.call(this,"");this.input.validate.call(this)},setRangeAtStartEnd:function(){var n,t,i=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=arguments[1];document.createRange&&((n=document.createRange()).selectNodeContents(r||this.DOM.input),n.collapse(i),(t=window.getSelection()).removeAllRanges(),t.addRange(n))},validate:function(){var n=!this.input.value||this.validateTag.call(this,this.input.value);this.DOM.input.classList.toggle("tagify__input--invalid",!0!==n)},normalize:function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.DOM.input).innerText.replace(/\s/g," ").replace(/^\s+/,"")},autocomplete:{suggest:function(n){n&&this.input.value?this.DOM.input.setAttribute("data-suggest",n.substring(this.input.value.length)):this.DOM.input.removeAttribute("data-suggest")},set:function(n){var t=this.DOM.input.getAttribute("data-suggest"),i=n||(t?this.input.value+t:null);return!!i&&(this.input.set.call(this,i),this.input.autocomplete.suggest.call(this,""),this.dropdown.hide.call(this),this.input.setRangeAtStartEnd.call(this),!0)}}},getNodeIndex:function(n){for(var t=0;n=n.previousElementSibling;)t++;return t},isTagDuplicate:function(n){return this.value.findIndex(function(t){return n.trim().toLowerCase()===t.value.toLowerCase()})},getTagIndexByValue:function(n){var t=[];return this.DOM.scope.querySelectorAll("tag").forEach(function(i,r){i.textContent.trim().toLowerCase()==n.toLowerCase()&&t.push(r)}),t},getTagElmByValue:function(n){var t=this.getTagIndexByValue(n)[0];return this.DOM.scope.querySelectorAll("tag")[t]},markTagByValue:function(n,t){return!!(t=t||this.getTagElmByValue(n))&&(t.classList.add("tagify--mark"),setTimeout(function(){t.classList.remove("tagify--mark")},100),t)},isTagBlacklisted:function(n){return n=n.toLowerCase().trim(),console.log(n),this.settings.blacklist.filter(function(t){return n==t.toLowerCase()}).length},isTagWhitelisted:function(n){return this.settings.whitelist.some(function(t){if((t.value||t).toLowerCase()===n.toLowerCase())return!0})},validateTag:function(n){var i=n.trim(),r=this.value.length>=this.settings.maxTags,t=!0;return i?r?t=this.TEXTS.exceed:this.settings.pattern&&!this.settings.pattern.test(i)?t=this.TEXTS.pattern:this.settings.duplicates||-1===this.isTagDuplicate(i)?(this.isTagBlacklisted(i)||this.settings.enforceWhitelist&&!this.isTagWhitelisted(i))&&(t=this.TEXTS.notAllowed):t=this.TEXTS.duplicate:t=this.TEXTS.empty,t},normalizeTags:function(n){var i=this,r=this.settings.whitelist[0]instanceof Object,u=n instanceof Array&&n[0]instanceof Object&&"value"in n[0],t=[];if(u)return n;if("number"==typeof n&&(n=n.toString()),"string"==typeof n){if(!n.trim())return[];n=n.split(this.settings.delimiters).filter(function(n){return n}).map(function(n){return{value:n.trim()}})}else n instanceof Array&&(n=n.map(function(n){return{value:n.trim()}}));return r?(n.forEach(function(n){var r=i.settings.whitelist.filter(function(t){return t.value.toLowerCase()==n.value.toLowerCase()});r[0]?t.push(r[0]):"mix"!=i.settings.mode&&t.push(n)}),t):n},parseMixTags:function(n){var t=this;return n.split(this.settings.mixTagsAllowedAfter).filter(function(n){return n.match(t.settings.pattern)}).forEach(function(i){var r,u=i.replace(t.settings.pattern,"");t.isTagWhitelisted(u)&&(r=t.normalizeTags.call(t,u)[0],n=t.replaceMixStringWithTag(n,i,r).s)}),this.DOM.input.innerHTML=n,this.update(),n},replaceMixStringWithTag:function(n,t,i,r){return i&&n&&-1!=n.indexOf(t)&&(r=this.createTagElem(i),this.value.push(i),n=n.replace(t,r.outerHTML+"&#8288;")),{s:n,tagElm:r}},addMixTag:function(n){if(n&&this.state.tag){for(var t,i,u,r,f=this.state.tag.prefix+this.state.tag.value,e=document.createNodeIterator(this.DOM.input,NodeFilter.SHOW_TEXT);t=e.nextNode();)if(t.nodeType===Node.TEXT_NODE){if(-1==(u=t.nodeValue.indexOf(f)))continue;r=t.splitText(u);i=this.createTagElem(n);r.nodeValue=r.nodeValue.replace(f,"");t.parentNode.insertBefore(i,r);i.insertAdjacentHTML("afterend","&#8288;")}i&&(this.value.push(n),this.update(),this.trigger("add",this.extend({},{index:this.value.length,tag:i},n)));this.state.tag=null}},addTags:function(n,t){var i=this,r=[];return(n=this.normalizeTags.call(this,n),"mix"==this.settings.mode)?this.addMixTag(n[0]):(this.DOM.input.removeAttribute("style"),n.forEach(function(n){var u,t;n=Object.assign({},n);"function"==typeof i.settings.transformTag&&(n.value=i.settings.transformTag.call(i,n.value)||n.value);!0!==(u=i.validateTag.call(i,n.value))&&(n.class=n.class?n.class+" tagify--notAllowed":"tagify--notAllowed",n.title=u,i.markTagByValue(n.value),i.trigger("invalid",{data:n,index:i.value.length,message:u}));t=i.createTagElem(n);r.push(t),function(n){var t=this.DOM.scope.lastElementChild;t===this.DOM.input?this.DOM.scope.insertBefore(n,t):this.DOM.scope.appendChild(n)}.call(i,t);!0===u?(i.value.push(n),i.update(),i.DOM.scope.classList.toggle("hasMaxTags",i.value.length>=i.settings.maxTags),i.trigger("add",{tag:t,index:i.value.length-1,data:n})):i.settings.keepInvalidTags||setTimeout(function(){i.removeTag(t,!0)},1e3)}),n.length&&t&&this.input.set.call(this),r)},minify:function(n){return n.replace(new RegExp(">[\r\n ]+<","g"),"><")},createTagElem:function(n){var r,i=this.escapeHtml(n.value),t="<tag title='"+i+"' contenteditable='false' spellcheck=\"false\">\n                            <x title=''><\/x><div><span class='tagify__tag-text'>"+i+"<\/span><\/div>\n                        <\/tag>";if("function"==typeof this.settings.tagTemplate)try{t=this.settings.tagTemplate(i,n)}catch(n){}return this.settings.readonly&&(n.readonly=!0),t=this.minify(t),function(n,t){for(var u=Object.keys(t),i,r=u.length;r--;){if(i=u[r],!t.hasOwnProperty(i))return;n.setAttribute(i,t[i])}}(r=this.parseHTML(t),n),r},removeTag:function(n,t){function f(){n.parentNode&&n.parentNode.removeChild(n)}var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:250,u,i;n&&n instanceof HTMLElement&&("string"==typeof n&&(n=this.getTagElmByValue(n)),i=this.getNodeIndex(n),r&&10<r?(n.style.width=parseFloat(window.getComputedStyle(n).width)+"px",document.body.clientTop,n.classList.add("tagify--hide"),setTimeout(f,400)):f(),t||(u=this.value.splice(i,1)[0],this.update(),this.trigger("remove",{tag:n,index:i,data:u})))},removeAllTags:function(){this.value=[];this.update();Array.prototype.slice.call(this.DOM.scope.querySelectorAll("tag")).forEach(function(n){return n.parentNode.removeChild(n)})},update:function(){this.DOM.originalInput.value="mix"==this.settings.mode?this.DOM.input.textContent:JSON.stringify(this.value)},dropdown:{init:function(){this.DOM.dropdown=this.dropdown.build.call(this)},build:function(){var n='<div class="'+("tagify__dropdown "+this.settings.dropdown.classname).trim()+'"><\/div>';return this.parseHTML(n)},show:function(n){var t,i=this;if(this.settings.whitelist.length){if(this.suggestedListItems=n?this.dropdown.filterListItems.call(this,n):this.settings.whitelist.filter(function(n){return-1==i.isTagDuplicate(n.value||n)}),!this.suggestedListItems.length)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide.call(this);t=this.dropdown.createListHTML.call(this,this.suggestedListItems);this.settings.autoComplete&&this.input.autocomplete.suggest.call(this,this.suggestedListItems.length?this.suggestedListItems[0].value:"");this.DOM.dropdown.innerHTML=t;this.dropdown.position.call(this);!this.DOM.dropdown.parentNode!=document.body&&(document.body.appendChild(this.DOM.dropdown),this.events.binding.call(this,!1),this.dropdown.events.binding.call(this))}},hide:function(){this.DOM.dropdown&&this.DOM.dropdown.parentNode==document.body&&(document.body.removeChild(this.DOM.dropdown),window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),this.events.binding.call(this))},position:function(){var n=this.DOM.scope.getBoundingClientRect();this.DOM.dropdown.style.cssText="left: "+(n.left+window.pageXOffset)+"px;                                                top: "+(n.top+n.height-1+window.pageYOffset)+"px;                                                width: "+n.width+"px"},events:{binding:function(){var i=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this),onKeyDown:this.dropdown.events.callbacks.onKeyDown.bind(this),onMouseOver:this.dropdown.events.callbacks.onMouseOver.bind(this),onClick:this.dropdown.events.callbacks.onClick.bind(this)},t=i?"addEventListener":"removeEventListener";window[t]("resize",n.position);window[t]("keydown",n.onKeyDown);window[t]("mousedown",n.onClick);this.DOM.dropdown[t]("mouseover",n.onMouseOver)},callbacks:{onKeyDown:function(n){var t=this.DOM.dropdown.querySelectorAll("[class$='--active']")[0],i="";switch(n.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":n.preventDefault();t&&(t=t[("ArrowUp"==n.key||"Up"==n.key?"previous":"next")+"ElementSibling"]);t||(t=this.DOM.dropdown.children["ArrowUp"==n.key||"Up"==n.key?this.DOM.dropdown.children.length-1:0]);this.dropdown.highlightOption.call(this,t,!0);break;case"Escape":case"Esc":this.dropdown.hide.call(this);break;case"ArrowRight":case"Tab":if(n.preventDefault(),!this.input.autocomplete.set.call(this,t?t.textContent:null))return!1;case"Enter":return n.preventDefault(),i=this.suggestedListItems[this.getNodeIndex(t)]||this.input.value,this.addTags([i],!0),this.dropdown.hide.call(this),!1}},onMouseOver:function(n){n.target.className.includes("__item")&&this.dropdown.highlightOption.call(this,n.target)},onClick:function(n){var t,i,r=this,u=function(){return r.dropdown.hide.call(r)};if(0==n.button){if(n.target==document.documentElement)return u();(i=[n.target,n.target.parentNode].filter(function(n){return n.className.includes("tagify__dropdown__item")})[0])?(t=this.suggestedListItems[this.getNodeIndex(i)]||this.input.value,this.addTags([t],!0),this.dropdown.hide.call(this)):u()}}}},highlightOption:function(n,t){if(n){var i="tagify__dropdown__item--active";[].forEach.call(this.DOM.dropdown.querySelectorAll("[class$='--active']"),function(n){return n.classList.remove(i)});n.classList.add(i);t&&(n.parentNode.scrollTop=n.clientHeight+n.offsetTop-n.parentNode.clientHeight)}},filterListItems:function(n){if(!n)return"";for(var r,u=[],i=this.settings.whitelist,f=this.settings.dropdown.maxItems||1/0,t=0;t<i.length&&(0==(r=i[t]instanceof Object?i[t]:{value:i[t]}).value.toLowerCase().indexOf(n.toLowerCase())&&-1==this.isTagDuplicate(r.value)&&f--&&u.push(r),0!=f);t++);return u},createListHTML:function(n){var t=this.settings.dropdown.itemTemplate||function(n){return"<div class='tagify__dropdown__item "+(n.class?n.class:"")+"' "+function(n){for(var r=Object.keys(n),u="",t,i=r.length;i--;){if(t=r[i],"class"!=t&&!n.hasOwnProperty(t))return;u+=" "+t+(n[t]?"="+n[t]:"")}return u}(n)+">"+(n.value||n)+"<\/div>"};return n.map(t).join("")}}}}(jQuery);