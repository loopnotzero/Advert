@using Advert.Models.Post
@model PostsAggregatorViewModel

@await Html.PartialAsync("_Header", Model.Profile)

<style>
    .pac-container { z-index: 2000 !important; }
</style>

<section id="@Model.Posts.First().PostId" class="content">
    <div class="row">
        <div class="col-md-8 p-1">
            <div class="card">
                <div class="card-header">
                    @await Html.PartialAsync("PostHeaderPartial", Model.Posts.First())
                </div>
                <div class="card-body">
                    <h4 class="card-text__title font-weight-bold cut-long-text">@Model.Posts.First().Title</h4>
                    @await Html.PartialAsync("PostContentPartial", Model.Posts.First())
                </div>
                <div class="card-footer">
                    @await Html.PartialAsync("PostFooterPartial", Model.Posts.First())
                </div>
                <div id="comment-form" class="p-4">
                    <textarea id="write-comment__editor" style="display: none"></textarea>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button id="post-comment" class="btn btn-primary__advert waves-effect waves-light btn-sm">COMMENT</button>
                        </div>
                    </div>
                </div>
                <div id="post-comments" class="container-fluid">
                    @await Html.PartialAsync("PostCommentsPartial", Model.PostComments)
                </div>
            </div>
        </div>
@*         <div class="col-md-4 p-1"> *@
@*             <div class="card p-4"> *@
@*                 <div style="border-bottom: 1px solid #d5d5d5; margin-bottom: 10px;"> *@
@*                     <h4 class="text-muted">Recommendations</h4> *@
@*                 </div> *@
@*                 @{ *@
@*                     @await Html.PartialAsync("RecommendedPosts", Model.RecommendedPosts) *@
@*                 } *@
@*             </div> *@
@*         </div> *@
    </div>
    @await Html.PartialAsync("AddPostModal")
    @await Html.PartialAsync("EditPostModal")
    @await Html.PartialAsync("DeletePostModal")
    @await Html.PartialAsync("EditPostTagsModal", Model.Posts.First())
</section>

<script>    
    var writeCommentEditor = new SimpleMDE({
        status: false,
        element: $("#write-post__editor")[0],
        placeholder: "Write something...",
        fullScreen: false,
        withPreview: false,
        spellChecker: false
    });

    $(document).ready(function() {
        $("#post-comment").click(function() {
            var postId = $("section").attr('id')
            var text = writeCommentEditor.options.previewRender(writeCommentEditor.value());
            var comment = {
                postId: postId,
                text: text
            }
            createPostCommentAsync(comment,
                function(response) {
                    $("#post-comments").prepend(`
                <div id="${response.commentId}" class="media p-2">
                    <img class="card-user__img" src="${response.profileImagePath
                        }" width="48" height="48" alt="profile-image">
                    <div class="media-body media__img content__break">
                        <div class="col-auto">
                            <span class="font-weight-bold" style="font-size: 0.9rem">
                                <a href="/${response.profileName}">${response.profileName}</a>
                            </span>
                            <span class="time"> ${response.createdAt}</span>         
                        </div>                        
                        <div class="col-auto media__border">
                            <div id="media-comment__${response.commentId}" class="media__comment">
                                ${response.text}
                            </div>   
                        </div>
                        <div class="col-auto">
                            <div class="row">
                                <div class="col-md-12 p-1">
                                    <div class="r-btn r-btn-light r-btn--icon waves-effect ml-4" onclick="onPostCommentVoteClick('${
                        response.postId}', '${response.commentId}', 1)" >
                                        <i id="vote-icon__${response.commentId
                        }" class="zmdi zmdi-favorite-outline zmdi-hc-fw"></i>
                                    </div>
                                    <small id='votes-count__${response.commentId}'>${response.votesCount}</small>
                                    <span class="dot-separator"></span>
                                    <a href="#reply" onclick="onReplyCommentClick('${response.postId}', '${
                        response.replyTo}', '${response.commentId}')" style="font-size: 0.9rem">
                                        Reply
                                    </a>
                                    <span class="dot-separator"></span>
                                    <div class="dropdown comments__item">
                                        <i data-toggle="dropdown" class="zmdi zmdi-chevron-down zmdi-hc-fw" aria-expanded="false"></i>
                                        <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(30px, 26px, 0px);">
                                            <a href="" class="dropdown-item" data-placement="top" data-target="#edit-comment__modal" data-toggle="modal" onclick="onEditCommentClick('${response.commentId}')">
                                                <i class="zmdi zmdi-edit zmdi-hc-fw"></i> Edit...
                                            </a> 
                                            <a href="" class="dropdown-item" data-placement="top" data-target="#delete-comment__modal" data-toggle="modal" onclick="onDeleteCommentClick('${response.postId}', '${
                        response.commentId}')">
                                                <i class="zmdi zmdi-delete zmdi-hc-fw"></i> Delete...
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>                          
                        </div>
                        <div id="reply-placeholder"></div>
                    </div>
                </div>`);

                    $([document.documentElement, document.body]).animate({
                            scrollTop: $(`#${response.commentId}`).offset().top - 250
                        },
                        200);
                });
            writeCommentEditor.value("");
        });

        $("#add-post__currency").select2({
            tags: ["€", "$", "MDL"],
            width: "100%",
            height: "34px",
            minimumResultsForSearch: -1,
        });

        $("#edit-post__currency").select2({
            tags: ["€", "$", "MDL"],
            width: "100%",
            height: "34px",
            minimumResultsForSearch: -1,
        });

        $(".CodeMirror, .CodeMirror-scroll").css('min-height', '150px');
    });
</script>

@* <script src="https://maps.googleapis.com/maps/api/js?key=@Model.PlacesApi&libraries=places&callback=addInputListeners" async defer></script> *@